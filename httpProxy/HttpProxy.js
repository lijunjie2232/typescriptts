'use strict';const a13_0x5f5a91=a13_0x3342;function a13_0x3342(_0x38c115,_0x528d46){const _0x474419=a13_0x4744();return a13_0x3342=function(_0x3342a4,_0x75f0b3){_0x3342a4=_0x3342a4-0x164;let _0x50bdef=_0x474419[_0x3342a4];return _0x50bdef;},a13_0x3342(_0x38c115,_0x528d46);}(function(_0x268a8e,_0x58b59d){const _0x19de0d=a13_0x3342,_0x4205fc=_0x268a8e();while(!![]){try{const _0x4d8af2=-parseInt(_0x19de0d(0x1a9))/0x1*(-parseInt(_0x19de0d(0x16c))/0x2)+parseInt(_0x19de0d(0x186))/0x3*(-parseInt(_0x19de0d(0x165))/0x4)+parseInt(_0x19de0d(0x175))/0x5*(parseInt(_0x19de0d(0x169))/0x6)+-parseInt(_0x19de0d(0x190))/0x7*(parseInt(_0x19de0d(0x1d4))/0x8)+parseInt(_0x19de0d(0x170))/0x9+parseInt(_0x19de0d(0x1d6))/0xa+-parseInt(_0x19de0d(0x18c))/0xb;if(_0x4d8af2===_0x58b59d)break;else _0x4205fc['push'](_0x4205fc['shift']());}catch(_0x37a45e){_0x4205fc['push'](_0x4205fc['shift']());}}}(a13_0x4744,0x2153e));var __createBinding=this&&this[a13_0x5f5a91(0x17c)]||(Object[a13_0x5f5a91(0x1b0)]?function(_0x14d95e,_0x46df60,_0x535f57,_0x49c43b){const _0x49e11f=a13_0x5f5a91;if(_0x49c43b===undefined)_0x49c43b=_0x535f57;var _0x2bafc4=Object['getOwnPropertyDescriptor'](_0x46df60,_0x535f57);(!_0x2bafc4||(_0x49e11f(0x1bc)in _0x2bafc4?!_0x46df60[_0x49e11f(0x1cd)]:_0x2bafc4['writable']||_0x2bafc4['configurable']))&&(_0x2bafc4={'enumerable':!![],'get':function(){return _0x46df60[_0x535f57];}}),Object[_0x49e11f(0x1a6)](_0x14d95e,_0x49c43b,_0x2bafc4);}:function(_0x3f0aca,_0x56ffc0,_0x573975,_0x52f6e9){if(_0x52f6e9===undefined)_0x52f6e9=_0x573975;_0x3f0aca[_0x52f6e9]=_0x56ffc0[_0x573975];}),__setModuleDefault=this&&this[a13_0x5f5a91(0x1a3)]||(Object[a13_0x5f5a91(0x1b0)]?function(_0x18f560,_0x1c315d){const _0x247f74=a13_0x5f5a91;Object[_0x247f74(0x1a6)](_0x18f560,'default',{'enumerable':!![],'value':_0x1c315d});}:function(_0x3c7eb1,_0x44d97d){_0x3c7eb1['default']=_0x44d97d;}),__importStar=this&&this[a13_0x5f5a91(0x172)]||function(_0x28453e){const _0x4a68da=a13_0x5f5a91;if(_0x28453e&&_0x28453e['__esModule'])return _0x28453e;var _0x2b628f={};if(_0x28453e!=null){for(var _0x2f2c48 in _0x28453e)if(_0x2f2c48!==_0x4a68da(0x187)&&Object[_0x4a68da(0x1c4)]['hasOwnProperty'][_0x4a68da(0x1d7)](_0x28453e,_0x2f2c48))__createBinding(_0x2b628f,_0x28453e,_0x2f2c48);}return __setModuleDefault(_0x2b628f,_0x28453e),_0x2b628f;},__awaiter=this&&this[a13_0x5f5a91(0x1a8)]||function(_0x457044,_0x41a8cd,_0x75c15e,_0x231656){function _0x17b2eb(_0x2a6e87){return _0x2a6e87 instanceof _0x75c15e?_0x2a6e87:new _0x75c15e(function(_0x58b721){_0x58b721(_0x2a6e87);});}return new(_0x75c15e||(_0x75c15e=Promise))(function(_0x32bd0d,_0x11a019){const _0x508a88=a13_0x3342;function _0x1985cc(_0x23c86f){try{_0x704961(_0x231656['next'](_0x23c86f));}catch(_0x47aa4f){_0x11a019(_0x47aa4f);}}function _0x13cb78(_0x1f4176){const _0x3e5bd3=a13_0x3342;try{_0x704961(_0x231656[_0x3e5bd3(0x1cf)](_0x1f4176));}catch(_0x55de6e){_0x11a019(_0x55de6e);}}function _0x704961(_0x1ad51e){const _0x4b3a02=a13_0x3342;_0x1ad51e[_0x4b3a02(0x195)]?_0x32bd0d(_0x1ad51e[_0x4b3a02(0x1d2)]):_0x17b2eb(_0x1ad51e[_0x4b3a02(0x1d2)])[_0x4b3a02(0x168)](_0x1985cc,_0x13cb78);}_0x704961((_0x231656=_0x231656[_0x508a88(0x18a)](_0x457044,_0x41a8cd||[]))[_0x508a88(0x177)]());});};Object[a13_0x5f5a91(0x1a6)](exports,'__esModule',{'value':!![]}),exports[a13_0x5f5a91(0x1b7)]=void 0x0;function a13_0x4744(){const _0xda0656=['18424NTqpEg','close','1113230RuZDgy','call','log','whitelist','authenticate','92GckGDg','split','incrementAuthFailure','then','677640mVVwLn','port','Closing\x20the\x20server...','86frdgMc','maxFailedAttempts','443','remoteAddress','118944xNRcPO','Closing\x20connection\x20for\x20','__importStar','Closed\x20active\x20connections','HTTP/1.1\x20500\x20Internal\x20Server\x20Error\x0d\x0a\x0d\x0a','10ZEHdDQ','../Auth','next','serverIpFiltering','password','Malformed\x20HTTPS\x20request:\x20Invalid\x20URL\x20-\x20','isBlockedServer','__createBinding','config','isBlockedIP','configManager','clientIpFiltering','HttpsSession','authentication','method','set','Malformed\x20HTTPS\x20request:\x20Missing\x20URL','15264bIOwSb','default','HTTP/HTTPS\x20proxy\x20server\x20listening\x20on\x20','HTTP/1.1\x20403\x20Forbidden\x0d\x0a\x0d\x0a','apply','httpServer','47421ArMjcg','Maximum\x20concurrent\x20sessions\x20reached\x20(','logger','IP\x20not\x20whitelisted:\x20','287SlhThB','clear','server','Access\x20to\x20the\x20requested\x20URL\x20is\x20blocked:\x20','url','done','authHandler','handleHttpsRequest','maxConcurrentConnections','remotePort','length','HttpSession','Access\x20Denied','writeHead','http','Malformed\x20HTTP\x20request:\x20Missing\x20URL','isWhitelistedServer','handleHttpRequest','Remote\x20server\x20','__setModuleDefault','Bad\x20Request:\x20Missing\x20URL','activeConnections','defineProperty','Error\x20handling\x20HTTP\x20request:\x20','__awaiter','43BtKzxb','blacklist','Error\x20handling\x20HTTPS\x20request:\x20',').\x20Rejecting\x20new\x20connection.','error','HTTP/1.1\x20400\x20Bad\x20Request\x0d\x0a\x0d\x0a','Error\x20closing\x20HTTP/HTTPS\x20proxy\x20server:\x20','create','Bad\x20Request','write','failedAuthAttempts','Received\x20HTTPS\x20request','UserPassAuth','Unauthorized','HttpProxy','isWhitelistedIP','ConfigManager','New\x20connection\x20from\x20','destroy','get','start','HTTP/1.1\x20401\x20Unauthorized\x0d\x0a\x0d\x0a','Malformed\x20HTTP\x20request:\x20Invalid\x20URL\x20-\x20','Parsed\x20target\x20host:\x20','Is\x20Blocked\x20:\x20','hostname','socket','prototype','Access\x20to\x20the\x20requested\x20URL\x20is\x20not\x20allowed','createServer','info','serverIP','Internal\x20Server\x20Error','end','includes','Rejected\x20target\x20IP:\x20','__esModule','replace','throw','debug','processRequest','value','credentials'];a13_0x4744=function(){return _0xda0656;};return a13_0x4744();}const http=__importStar(require('http')),Auth_1=require(a13_0x5f5a91(0x176)),SessionMonitor_1=require('../SessionMonitor'),HttpSession_1=require('./HttpSession'),ConfigManager_1=require('../ConfigManager');class HttpProxy{constructor(_0x33211b,_0x8b6eab){const _0xb75a7b=a13_0x5f5a91;this[_0xb75a7b(0x17f)]=new ConfigManager_1[(_0xb75a7b(0x1b9))](_0x33211b),this[_0xb75a7b(0x18e)]=_0x8b6eab,this['failedAuthAttempts']=new Map(),this['activeConnections']=new Map(),this[_0xb75a7b(0x17f)]['config'][_0xb75a7b(0x182)][_0xb75a7b(0x183)]===_0xb75a7b(0x179)?this[_0xb75a7b(0x196)]=new Auth_1[(_0xb75a7b(0x1b5))](this[_0xb75a7b(0x17f)][_0xb75a7b(0x17d)][_0xb75a7b(0x1d3)]):this[_0xb75a7b(0x196)]=null,this[_0xb75a7b(0x18b)]=http[_0xb75a7b(0x1c6)]((_0x539f5c,_0x58e8d1)=>this[_0xb75a7b(0x1a1)](_0x539f5c,_0x58e8d1)),this[_0xb75a7b(0x18b)]['on']('connect',(_0x365fce,_0xb7834b,_0x3254c6)=>this[_0xb75a7b(0x197)](_0x365fce,_0xb7834b,_0x3254c6)),this[_0xb75a7b(0x18b)]['on']('connection',_0x4b4f42=>{const _0x14f372=_0xb75a7b;if(this[_0x14f372(0x1a5)]['size']>=this['configManager'][_0x14f372(0x17d)][_0x14f372(0x192)][_0x14f372(0x198)])this[_0x14f372(0x18e)][_0x14f372(0x1c7)](_0x14f372(0x18d)+this[_0x14f372(0x17f)][_0x14f372(0x17d)][_0x14f372(0x192)][_0x14f372(0x198)]+_0x14f372(0x1ac)),_0x4b4f42[_0x14f372(0x1bb)]();else{this[_0x14f372(0x18e)][_0x14f372(0x1c7)](_0x14f372(0x1ba)+_0x4b4f42['remoteAddress']+':'+_0x4b4f42[_0x14f372(0x199)]);const _0x1eb849=new SessionMonitor_1['SessionMonitor'](_0x4b4f42);this[_0x14f372(0x1a5)]['set'](_0x4b4f42,_0x1eb849),_0x4b4f42['on']('close',()=>{const _0x522f08=_0x14f372;this[_0x522f08(0x18e)][_0x522f08(0x1c7)](_0x522f08(0x171)+_0x4b4f42['remoteAddress']+':'+_0x4b4f42[_0x522f08(0x199)]),this['activeConnections']['delete'](_0x4b4f42);});}});}[a13_0x5f5a91(0x1a1)](_0x240431,_0x59155c){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x55d6be=a13_0x3342;this[_0x55d6be(0x18e)][_0x55d6be(0x1d0)]('Receveid\x20HTTP\x20request'),this[_0x55d6be(0x18e)][_0x55d6be(0x1d0)](_0x55d6be(0x1a2)+_0x240431[_0x55d6be(0x194)]),console['log'](this[_0x55d6be(0x17f)][_0x55d6be(0x17d)]['clientIpFiltering'][_0x55d6be(0x1d9)]),console[_0x55d6be(0x1d8)](this[_0x55d6be(0x17f)]['config'][_0x55d6be(0x180)]['blacklist']),console[_0x55d6be(0x1d8)](this[_0x55d6be(0x17f)][_0x55d6be(0x17d)][_0x55d6be(0x178)]['whitelist']),console[_0x55d6be(0x1d8)](this[_0x55d6be(0x17f)][_0x55d6be(0x17d)][_0x55d6be(0x178)][_0x55d6be(0x1aa)]);try{if(!_0x240431[_0x55d6be(0x194)]){this[_0x55d6be(0x18e)][_0x55d6be(0x1ad)](_0x55d6be(0x19f)),_0x59155c[_0x55d6be(0x19d)](0x190,_0x55d6be(0x1b1)),_0x59155c[_0x55d6be(0x1ca)](_0x55d6be(0x1a4));return;}const _0x40683d=new URL(_0x240431[_0x55d6be(0x194)])[_0x55d6be(0x1c2)];if(!_0x40683d){this['logger'][_0x55d6be(0x1ad)](_0x55d6be(0x1bf)+_0x240431[_0x55d6be(0x194)]),_0x59155c['writeHead'](0x190,_0x55d6be(0x1b1)),_0x59155c['end']('Bad\x20Request:\x20Invalid\x20URL');return;}if(this[_0x55d6be(0x17e)](_0x240431[_0x55d6be(0x1c3)][_0x55d6be(0x16f)])){this[_0x55d6be(0x18e)][_0x55d6be(0x1c7)]('Rejected\x20blacklisted\x20IP:\x20'+_0x240431[_0x55d6be(0x1c3)]['remoteAddress']),_0x59155c[_0x55d6be(0x19d)](0x193),_0x59155c[_0x55d6be(0x1ca)](_0x55d6be(0x19c));return;}if(!this[_0x55d6be(0x1b8)](_0x240431[_0x55d6be(0x1c3)][_0x55d6be(0x16f)])){this[_0x55d6be(0x18e)][_0x55d6be(0x1c7)](_0x55d6be(0x18f)+_0x240431[_0x55d6be(0x1c3)]['remoteAddress']),_0x59155c[_0x55d6be(0x19d)](0x193),_0x59155c['end'](_0x55d6be(0x19c));return;}if(!(yield this[_0x55d6be(0x164)](_0x240431))){_0x59155c[_0x55d6be(0x19d)](0x191),_0x59155c[_0x55d6be(0x1ca)](_0x55d6be(0x1b6));return;}if(yield this[_0x55d6be(0x17b)](_0x40683d)){_0x59155c[_0x55d6be(0x19d)](0x193),_0x59155c[_0x55d6be(0x1ca)]('Access\x20to\x20the\x20requested\x20URL\x20is\x20blocked'),this[_0x55d6be(0x18e)]['info']('Rejected\x20target\x20IP:\x20'+_0x40683d);return;}if(yield!this[_0x55d6be(0x1a0)](_0x40683d)){_0x59155c['writeHead'](0x193),_0x59155c['end'](_0x55d6be(0x1c5)),this['logger']['info'](_0x55d6be(0x1cc)+_0x40683d);return;}this[_0x55d6be(0x18e)][_0x55d6be(0x1d0)](_0x55d6be(0x1c1)+(yield this['isBlockedServer'](_0x40683d)));const _0x365570=new HttpSession_1[(_0x55d6be(0x19b))](_0x240431,_0x59155c,this[_0x55d6be(0x18e)],this[_0x55d6be(0x17f)]);this['logger'][_0x55d6be(0x1d0)]('No\x20error\x20in\x20instantiation\x20of\x20httpSession'),_0x365570[_0x55d6be(0x1d1)]();}catch(_0x17ea23){this[_0x55d6be(0x18e)][_0x55d6be(0x1ad)](_0x55d6be(0x1a7)+_0x17ea23),_0x59155c[_0x55d6be(0x19d)](0x1f4,_0x55d6be(0x1c9)),_0x59155c['end']('Internal\x20Server\x20Error');}});}[a13_0x5f5a91(0x197)](_0x4bb77b,_0x5861a3,_0x288dbc){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x5d3aa1=a13_0x3342;this[_0x5d3aa1(0x18e)][_0x5d3aa1(0x1d0)](_0x5d3aa1(0x1b4)),this[_0x5d3aa1(0x18e)][_0x5d3aa1(0x1d0)]('Received\x20HTTPS\x20header:\x20'+_0x288dbc),this[_0x5d3aa1(0x18e)][_0x5d3aa1(0x1d0)]('Remote\x20server\x20URL:\x20'+_0x4bb77b[_0x5d3aa1(0x194)]);try{if(!_0x4bb77b['url']){this[_0x5d3aa1(0x18e)][_0x5d3aa1(0x1ad)](_0x5d3aa1(0x185)),_0x5861a3[_0x5d3aa1(0x1b2)](_0x5d3aa1(0x1ae)),_0x5861a3['destroy']();return;}let _0x1446d5,_0x189b71;[_0x1446d5,_0x189b71]=_0x4bb77b['url'][_0x5d3aa1(0x166)](':'),_0x189b71=_0x189b71||_0x5d3aa1(0x16e);if(!_0x1446d5){this[_0x5d3aa1(0x18e)][_0x5d3aa1(0x1ad)](_0x5d3aa1(0x17a)+_0x4bb77b[_0x5d3aa1(0x194)]),_0x5861a3[_0x5d3aa1(0x1b2)](_0x5d3aa1(0x1ae)),_0x5861a3['destroy']();return;}this['logger']['info'](_0x5d3aa1(0x1c0)+_0x1446d5+',\x20Port:\x20'+_0x189b71);if(this[_0x5d3aa1(0x17e)](_0x5861a3[_0x5d3aa1(0x16f)])){this['logger'][_0x5d3aa1(0x1c7)]('Rejected\x20blacklisted\x20IP:\x20'+_0x5861a3[_0x5d3aa1(0x16f)]),_0x5861a3['write'](_0x5d3aa1(0x189)),_0x5861a3[_0x5d3aa1(0x1bb)]();return;}if(!(yield this[_0x5d3aa1(0x164)](_0x4bb77b))){_0x5861a3[_0x5d3aa1(0x1b2)](_0x5d3aa1(0x1be)),_0x5861a3['destroy']();return;}if(yield this[_0x5d3aa1(0x17b)](_0x1446d5)){this[_0x5d3aa1(0x18e)][_0x5d3aa1(0x1c7)](_0x5d3aa1(0x193)+_0x1446d5),_0x5861a3[_0x5d3aa1(0x1b2)](_0x5d3aa1(0x189)),_0x5861a3[_0x5d3aa1(0x1bb)]();return;}const _0x3766be=new HttpSession_1[(_0x5d3aa1(0x181))](_0x4bb77b,_0x5861a3,_0x288dbc,this[_0x5d3aa1(0x18e)],this[_0x5d3aa1(0x17f)]);_0x3766be[_0x5d3aa1(0x1d1)]();}catch(_0x1fdd71){this[_0x5d3aa1(0x18e)][_0x5d3aa1(0x1ad)](_0x5d3aa1(0x1ab)+_0x1fdd71),_0x5861a3[_0x5d3aa1(0x1b2)](_0x5d3aa1(0x174)),_0x5861a3[_0x5d3aa1(0x1bb)]();}});}[a13_0x5f5a91(0x17b)](_0x353ac1){const _0x3af6b2=a13_0x5f5a91;return this['configManager'][_0x3af6b2(0x17d)]['serverIpFiltering']['blacklist']['includes'](_0x353ac1[_0x3af6b2(0x1ce)](/[\[\]]/g,'')[_0x3af6b2(0x1ce)](/^www\./,''));}[a13_0x5f5a91(0x1a0)](_0x4754c5){const _0x28b3a1=a13_0x5f5a91,_0x2533b1=this[_0x28b3a1(0x17f)][_0x28b3a1(0x17d)][_0x28b3a1(0x178)][_0x28b3a1(0x1d9)];if(!_0x2533b1||_0x2533b1['length']===0x0)return!![];return _0x2533b1['includes'](_0x4754c5);}[a13_0x5f5a91(0x17e)](_0x168302){const _0x5a2c63=a13_0x5f5a91;return this[_0x5a2c63(0x17f)][_0x5a2c63(0x17d)][_0x5a2c63(0x180)][_0x5a2c63(0x1aa)][_0x5a2c63(0x1cb)](_0x168302||'');}[a13_0x5f5a91(0x1b8)](_0x4e6dee){const _0x7b552=a13_0x5f5a91,_0x3502eb=this[_0x7b552(0x17f)]['config']['clientIpFiltering'][_0x7b552(0x1d9)];if(!_0x3502eb||_0x3502eb[_0x7b552(0x19a)]===0x0)return!![];return _0x3502eb[_0x7b552(0x1cb)](_0x4e6dee||'');}['authenticate'](_0xed2d37){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x2a5894=a13_0x3342;try{const _0x428c5d=_0xed2d37[_0x2a5894(0x1c3)]['remoteAddress']||'';let _0x356381=![];return this['authHandler']?(_0x356381=yield this[_0x2a5894(0x196)][_0x2a5894(0x164)](_0x2a5894(0x19e),{'headers':_0xed2d37['headers']}),!_0x356381&&this[_0x2a5894(0x167)](_0x428c5d)):_0x356381=!![],_0x356381;}catch(_0x258f36){return this[_0x2a5894(0x18e)]['error']('Authentication\x20error:\x20'+_0x258f36),![];}});}[a13_0x5f5a91(0x167)](_0x1faf31){const _0x24f042=a13_0x5f5a91,_0x5782da=(this[_0x24f042(0x1b3)][_0x24f042(0x1bc)](_0x1faf31)||0x0)+0x1;this[_0x24f042(0x1b3)][_0x24f042(0x184)](_0x1faf31,_0x5782da),_0x5782da>=this[_0x24f042(0x17f)][_0x24f042(0x17d)][_0x24f042(0x182)][_0x24f042(0x16d)]&&(this[_0x24f042(0x18e)][_0x24f042(0x1c7)]('Blacklisting\x20IP\x20due\x20to\x20too\x20many\x20failed\x20attempts:\x20'+_0x1faf31),this['configManager'][_0x24f042(0x17d)][_0x24f042(0x180)][_0x24f042(0x1aa)]['push'](_0x1faf31));}[a13_0x5f5a91(0x1bd)](){return __awaiter(this,void 0x0,void 0x0,function*(){return new Promise((_0x1410b7,_0x2d4d1d)=>{const _0x3c3cfe=a13_0x3342;this[_0x3c3cfe(0x18b)]['listen'](this[_0x3c3cfe(0x17f)][_0x3c3cfe(0x17d)][_0x3c3cfe(0x192)]['http'][_0x3c3cfe(0x16a)],this[_0x3c3cfe(0x17f)][_0x3c3cfe(0x17d)][_0x3c3cfe(0x192)][_0x3c3cfe(0x19e)][_0x3c3cfe(0x1c8)],()=>{const _0x134d42=_0x3c3cfe;this[_0x134d42(0x18e)][_0x134d42(0x1c7)](_0x134d42(0x188)+this[_0x134d42(0x17f)][_0x134d42(0x17d)][_0x134d42(0x192)][_0x134d42(0x19e)][_0x134d42(0x1c8)]+':'+this['configManager'][_0x134d42(0x17d)]['server']['http']['port']),_0x1410b7();}),this[_0x3c3cfe(0x18b)]['on'](_0x3c3cfe(0x1ad),_0x481f8d=>{const _0x4230ff=_0x3c3cfe;this[_0x4230ff(0x18e)][_0x4230ff(0x1ad)]('Error\x20starting\x20HTTP/HTTPS\x20proxy\x20server:\x20'+_0x481f8d),_0x2d4d1d(_0x481f8d);});});});}[a13_0x5f5a91(0x1d5)](){return __awaiter(this,void 0x0,void 0x0,function*(){return new Promise((_0x47c35b,_0xdbfdfd)=>{const _0x1f6663=a13_0x3342;this[_0x1f6663(0x1a5)]['forEach']((_0x3c96d5,_0x52c128)=>{const _0x1fa560=_0x1f6663;_0x52c128[_0x1fa560(0x1bb)]();}),this['activeConnections'][_0x1f6663(0x191)](),this[_0x1f6663(0x18e)][_0x1f6663(0x1c7)](_0x1f6663(0x173)),this[_0x1f6663(0x18b)]['close'](_0x4222d3=>{const _0x4eac48=_0x1f6663;_0x4222d3?(this[_0x4eac48(0x18e)][_0x4eac48(0x1ad)](_0x4eac48(0x1af)+_0x4222d3),_0xdbfdfd(_0x4222d3)):(this[_0x4eac48(0x18e)][_0x4eac48(0x1c7)](_0x4eac48(0x16b)),_0x47c35b());});});});}}exports[a13_0x5f5a91(0x1b7)]=HttpProxy;